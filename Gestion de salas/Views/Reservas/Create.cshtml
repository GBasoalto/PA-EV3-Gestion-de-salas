@model Gestion_de_salas.Models.Reserva

@{
    ViewData["Title"] = "Crear Reserva";
    var tipoUsuario = Context.Session.GetString("TipoUsuario");
}

<h2>Crear Reserva</h2>

<form asp-action="Create" method="post">

    <!-- FECHA -->
    <div class="form-group mb-3">
        <label asp-for="FechaReserva" class="form-label">Fecha</label>
        <input asp-for="FechaReserva" type="date" class="form-control"
               min="@ViewData["MinFecha"]" id="FechaReserva" />
        <span asp-validation-for="FechaReserva" class="text-danger"></span>
    </div>

    <!-- HORA INICIO -->
    <div class="form-group mb-3">
        <label asp-for="HoraInicio" class="form-label">Hora inicio</label>
        <select asp-for="HoraInicio" class="form-control" id="HoraInicio"></select>
        <span asp-validation-for="HoraInicio" class="text-danger"></span>
    </div>

    <!-- HORA FIN -->
    <div class="form-group mb-3">
        <label asp-for="HoraFin" class="form-label">Hora fin</label>
        <select asp-for="HoraFin" class="form-control" id="HoraFin"></select>
        <span asp-validation-for="HoraFin" class="text-danger"></span>
    </div>

    <!-- USUARIO (ADMIN) -->
    @if (tipoUsuario == "Administrador")
    {
        <div class="form-group mb-3">
            <label class="form-label">Buscar usuario</label>
            <input type="text" id="buscarUsuario" class="form-control" placeholder="Ingrese nombre o RUT..." />

            <div id="resultadosUsuarios"
                 style="border:1px solid #ddd; display:none; max-height:200px; overflow-y:auto; padding:5px;"></div>

            <input type="hidden" asp-for="UsuarioId" id="UsuarioId" />
            <span asp-validation-for="UsuarioId" class="text-danger"></span>
        </div>
    }

    <!-- SALA -->
    <div class="form-group mb-3">
        <label asp-for="SalaId" class="form-label">Sala</label>
        <select asp-for="SalaId"
                class="form-control"
                asp-items="@(ViewData["SalaId"] as SelectList)"
                id="SalaId">
        </select>
        <span asp-validation-for="SalaId" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Crear Reserva</button>

</form>

@section Scripts {
<script>
    // Convierte string "YYYY-MM-DD" a Date en zona local
    function parseFechaLocal(fechaStr) {
        const parts = fechaStr.split("-");
        return new Date(parts[0], parts[1]-1, parts[2]);
    }

    function actualizarHoras() {
        const fechaStr = $("#FechaReserva").val();
        if (!fechaStr) return;

        const fechaSeleccionada = parseFechaLocal(fechaStr);
        const hoy = new Date();
        const hoyLocal = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

        const esHoy = fechaSeleccionada.getTime() === hoyLocal.getTime();

        const $inicio = $("#HoraInicio");
        const $fin = $("#HoraFin");
        $inicio.empty();
        $fin.empty();

        let horaMin = 8;
        let minutoMin = 30;

        if (esHoy) {
            const now = new Date();
            horaMin = now.getHours();
            minutoMin = now.getMinutes() < 30 ? 30 : 0;
            if (now.getMinutes() >= 30) horaMin += 1;
            if (horaMin < 8) { horaMin = 8; minutoMin = 30; }
            if (horaMin > 21) { horaMin = 21; minutoMin = 30; }
        }

        // Hora inicio
        for (let h = 8; h <= 21; h++) {
            for (let m of [0,30]) {
                if (h < horaMin || (h === horaMin && m < minutoMin)) continue;
                const val = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                $inicio.append(new Option(val, val));
            }
        }

        // Hora fin: mínimo 30 min después de inicio
        const inicioSel = $inicio.val() ? $inicio.val().split(":") : [horaMin, minutoMin];
        let hIni = parseInt(inicioSel[0]);
        let mIni = parseInt(inicioSel[1]);
        let finHoraMin = hIni;
        let finMinutoMin = mIni + 30;
        if (finMinutoMin >= 60) { finHoraMin +=1; finMinutoMin -=60; }

        for (let h = 8; h <= 21; h++) {
            for (let m of [0,30]) {
                if (h < finHoraMin || (h === finHoraMin && m < finMinutoMin)) continue;
                const val = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                $fin.append(new Option(val, val));
            }
        }
    }

    $("#FechaReserva").on("change", actualizarHoras);
    $("#HoraInicio").on("change", actualizarHoras);
    $(document).ready(actualizarHoras);

    // BUSCADOR DE USUARIOS ADMIN
    $("#buscarUsuario").on("keyup", function () {
        var filtro = $(this).val();
        if (filtro.length < 2) {
            $("#resultadosUsuarios").hide();
            return;
        }
        $.getJSON("/Reservas/BuscarUsuarios", { filtro: filtro }, function (data) {
            var html = "";
            data.forEach(function (u) {
                html += `<div class="usuario-item" data-id="${u.id}">
                            <b>${u.nombre}</b> - ${u.rut}
                         </div>`;
            });
            $("#resultadosUsuarios").html(html).show();
        });
    });

    $(document).on("click", ".usuario-item", function () {
        var id = $(this).data("id");
        var texto = $(this).text();
        $("#UsuarioId").val(id);
        $("#buscarUsuario").val(texto);
        $("#resultadosUsuarios").hide();
    });
</script>
}
